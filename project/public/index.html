<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag and Drop Cards</title>
    <link rel="stylesheet" href="./style/style.css">
    <link rel="stylesheet" href="./style/default.css">
</head>
<body>
    <div class="Boards">
        <button onclick="buy()">TESTE BOTAO COMPRA</button>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board opponent-board">
            <h4>Oponente</h4>
            <div class="dropzone table">
                
            </div>
        </div>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board player-board">
            <h4>Jogador</h4>
            <div class="dropzone table">
                
            </div>
        </div>
        <!-- -------- END BOARDS ZONE ------- -->
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        socket.on('connect',function(){
            current_user = { id:socket.id };
        });

        document.querySelectorAll('.dropzone').forEach(dropzone => {

            dropzone.addEventListener('drop', function(event) {
                
                event.preventDefault();
                const cardId = event.dataTransfer.getData('cardId');
                console.log(`CARD ID CLIENT: ${cardId}`);

                const zoneId = this.closest('.Board').classList[1]; // ID da zona de soltura é a segunda classe da Board (opponent-board ou player-board)
                socket.emit('jogada', { cardId, zoneId,current_user });
            });

        });

        // Receber atualizações do servidor
        socket.on('atualizarTabuleiro', function(state) {
            let tabuleiro = state.tabuleiro;
            let zoneId = state.zoneId;
            let boards = state.boards;

            console.log(boards);

            // Atualizar o tabuleiro com os dados recebidos do servidor
            Object.keys(boards).forEach(boardKey => {
                const cards = boards[boardKey]; // Obter as cartas correspondentes à board atual

                const dropzone = document.querySelector(`.${boardKey} .dropzone`); // Selecionar a dropzone dentro da zona de soltura correta
                
                // Limpar a zona de soltura
                dropzone.innerHTML = '';

                // Adicionar as cartas atualizadas
                cards.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.classList.add('icon', 'card-i');
                    cardElement.setAttribute('draggable', 'true');
                    cardElement.id = card.cardId; // Ajuste para acessar corretamente o ID do card
                    cardElement.innerHTML = `<h5>Card ${card.cardId}</h5>`; // Você pode ajustar isso conforme necessário
                    dropzone.appendChild(cardElement);
                });
            });
        });

        const icons = document.querySelectorAll('.icon');
        let draggingIcon = null;

        icons.forEach(icon => {
            icon.addEventListener('dragstart', dragStart);
            icon.addEventListener('dragend', dragEnd);
        });

        function dragStart() {
            draggingIcon = this;
            setTimeout(() => this.style.display = 'none', 0);
        }

        function dragEnd() {
            draggingIcon = null;
            this.style.display = 'block';
        }

        const dropzones = document.querySelectorAll('.dropzone');

        dropzones.forEach(dropzone => {
            dropzone.addEventListener('dragover', dragOver);
            dropzone.addEventListener('dragenter', dragEnter);
            dropzone.addEventListener('dragleave', dragLeave);
            dropzone.addEventListener('drop', drop);
        });

        function dragOver(e) {
            e.preventDefault();
            console.log("dragOver");
        }

        function dragEnter(e) {
            console.log("dragEnter");
            e.preventDefault();
            this.classList.add('drag-enter');
        }

        function dragLeave() {
            console.log("dragLeave");
            this.classList.remove('drag-enter');
        }

        function drop() {
            console.log("drop");
            if (draggingIcon) {
                this.classList.remove('drag-enter');
                this.appendChild(draggingIcon);
            }
        }

        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
            );
        }

        function generateCard() {
            const card = document.createElement('div');
            card.classList.add('icon', 'card-i');
            card.setAttribute('draggable', 'true');
            const cardId = uuidv4(); // Gere um ID único para o card
            card.id = cardId;
            card.innerHTML = `<h5>Card ${cardId}</h5>`; // Você pode ajustar isso conforme necessário
            return card;
        }

        function buy(){
            const dropzonePlayerBoard = document.querySelector('.player-board .dropzone');
            const card = generateCard();
            
            dropzonePlayerBoard.appendChild(card); // Adicionar o card à dropzone atual
            let zoneId = "player-board"

            console.log("IN THE FUNCTION BUY",card.id);
            let cardId = card.id

            console.log(dropzonePlayerBoard);
            socket.emit("buy",{cardId,zoneId,current_user})
        }

        
    </script>
</body>
</html>
