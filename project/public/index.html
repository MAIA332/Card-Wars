<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag and Drop Cards</title>
    <link rel="stylesheet" href="./style/style.css">
    <link rel="stylesheet" href="./style/default.css">
</head>
<body>
    <div class="Boards">
        <button class="deck" onclick="buy()">TESTE BOTAO COMPRA</button>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board player2-board">
            <h4>Player2</h4>
            <div class="dropzone table">
                
            </div>
        </div>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board player1-board">
            <h4>Player1</h4>
            <div class="dropzone table">
            </div>
        </div>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board graveyard-board">
            
            <h4>Graveyard</h4>
            <div class="dropzone table"></div>

        </div>
        <!-- -------- END BOARDS ZONE ------- -->
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        socket.on('connect', function() {
            current_user = { id: socket.id };
        });

        document.querySelectorAll('.dropzone').forEach(dropzone => {
            dropzone.addEventListener('dragover', function(event) {
                event.preventDefault();
            });

            dropzone.addEventListener('drop', function(event) {

                event.preventDefault();

                const cardId = event.dataTransfer.getData('cardId');
                console.log(`CARD ID CLIENT: ${cardId}`);

                socket.emit('jogada', { current_user,cardId });
            });
        });

        socket.on('atualizarTabuleiro', function(cards) {

            console.log("CARDS: ", cards);

            let mycards = cards.filter((card)=>card.idPlayer == current_user.id)
            let opponentCards = cards.filter((card)=>card.idPlayer!=current_user.id)
            
            if (mycards && opponentCards) {
                console.log("MINHAS CARTAS: ",mycards);
                console.log("CARTAS DO OPONENTE: ",opponentCards);
            }

            clearBoards()
            renderCards(cards)

        });

        const icons = document.querySelectorAll('.icon');
        let draggingIcon = null;

        icons.forEach(icon => {
            icon.addEventListener('dragstart', dragStart);
            icon.addEventListener('dragend', dragEnd);
        });

        function dragStart(event) {
            event.dataTransfer.setData('cardId', this.id);
            draggingIcon = this;
            setTimeout(() => this.style.display = 'none', 0);
        }

        function dragEnd() {
            draggingIcon = null;
            this.style.display = 'block';
        }

        const dropzones = document.querySelectorAll('.dropzone');

        dropzones.forEach(dropzone => {
            dropzone.addEventListener('dragover', dragOver);
            dropzone.addEventListener('dragenter', dragEnter);
            dropzone.addEventListener('dragleave', dragLeave);
            dropzone.addEventListener('drop', drop);
        });

        function dragOver(e) {
            e.preventDefault();
        }

        function dragEnter(e) {
            e.preventDefault();
        }

        function dragLeave() {
            this.classList.remove('drag-enter');
        }

        function drop() {
            if (draggingIcon) {
                this.classList.remove('drag-enter');
                this.appendChild(draggingIcon);
            }
        }

        function renderCards(mycards) {

             mycards.forEach(card=>{

                const playerClass = card.idPlayer == current_user.id?'player1-board':'player2-board'
                
                const playerDropzone = document.querySelector(`.${playerClass} .dropzone`);

                const card_template = document.createElement('div');
                card_template.classList.add('icon', 'card-i');
                card_template.setAttribute('draggable', 'true');

                card_template.id = card.id;
                card_template.innerHTML = `<h5>Card ${card.id}</h5>`;
                card_template.addEventListener('dragstart', dragStart);
                card_template.addEventListener('dragend', dragEnd);

                playerDropzone.appendChild(card_template);
            })
            
        }

        function clearBoards(){
            const dropzones = document.querySelectorAll(`.dropzone`);
            
            for (const dropzone of dropzones) {
                dropzone.innerHTML = ''
            }
        }

        function buy(){
            socket.emit("buy",{current_user})
        }

        
    </script>
</body>
</html>
