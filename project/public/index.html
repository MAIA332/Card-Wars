<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag and Drop Cards</title>
    <link rel="stylesheet" href="./style/style.css">
    <link rel="stylesheet" href="./style/default.css">
</head>
<body>
    <div class="Boards">
        <button class="deck" onclick="buy()">TESTE BOTAO COMPRA</button>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board opponent-board">
            <h4>Player2</h4>
            <div class="dropzone table">
                
            </div>
        </div>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board player-board">
            <h4>Player1</h4>
            <div class="dropzone table">
                
            </div>
        </div>
        <!-- -------- BOARDS ZONE ------- -->
        <div class="Board graveyard-board">
            
            <h4>Graveyard</h4>
            <div class="dropzone table"></div>

        </div>
        <!-- -------- END BOARDS ZONE ------- -->
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        socket.on('connect', function() {
            current_user = { id: socket.id };
        });

        document.querySelectorAll('.dropzone').forEach(dropzone => {
            dropzone.addEventListener('dragover', function(event) {
                event.preventDefault();
            });

            dropzone.addEventListener('drop', function(event) {

                event.preventDefault();

                const cardId = event.dataTransfer.getData('cardId');
                console.log(`CARD ID CLIENT: ${cardId}`);

                const zoneId = this.closest('.Board').classList[1];
                console.log("ZONE ID ON DROP: ",zoneId);
                socket.emit('jogada', { cardId, zoneId, current_user });
            });
        });

        socket.on('atualizarTabuleiro', function(state) {

            const boards = state.boards;
            console.log("BOARDS UPDATED: ", boards);

            Object.keys(boards).forEach(boardKey => {
                const cards = boards[boardKey];
                const dropzone = document.querySelector(`.${boardKey} .dropzone`);
                dropzone.innerHTML = '';

                cards.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.classList.add('icon', 'card-i');
                    cardElement.setAttribute('draggable', 'true');
                    cardElement.id = card.cardId;
                    cardElement.innerHTML = `<h5>Card ${card.cardId}</h5>`;
                    cardElement.addEventListener('dragstart', dragStart);
                    cardElement.addEventListener('dragend', dragEnd);
                    dropzone.appendChild(cardElement);
                });
            });
        });

        const icons = document.querySelectorAll('.icon');
        let draggingIcon = null;

        icons.forEach(icon => {
            icon.addEventListener('dragstart', dragStart);
            icon.addEventListener('dragend', dragEnd);
        });

        function dragStart(event) {
            event.dataTransfer.setData('cardId', this.id);
            draggingIcon = this;
            setTimeout(() => this.style.display = 'none', 0);
        }

        function dragEnd() {
            draggingIcon = null;
            this.style.display = 'block';
        }

        const dropzones = document.querySelectorAll('.dropzone');

        dropzones.forEach(dropzone => {
            dropzone.addEventListener('dragover', dragOver);
            dropzone.addEventListener('dragenter', dragEnter);
            dropzone.addEventListener('dragleave', dragLeave);
            dropzone.addEventListener('drop', drop);
        });

        function dragOver(e) {
            e.preventDefault();
            console.log("dragOver");
        }

        function dragEnter(e) {
            console.log("dragEnter");
            e.preventDefault();
            this.classList.add('drag-enter');
        }

        function dragLeave() {
            console.log("dragLeave");
            this.classList.remove('drag-enter');
        }

        function drop() {
            console.log("drop");
            if (draggingIcon) {
                this.classList.remove('drag-enter');
                this.appendChild(draggingIcon);
            }
        }

        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
            );
        }

        function generateCard() {
            const card = document.createElement('div');
            card.classList.add('icon', 'card-i');
            card.setAttribute('draggable', 'true');

            const cardId = uuidv4();
            card.id = cardId;
            card.innerHTML = `<h5>Card ${cardId}</h5>`;
            card.addEventListener('dragstart', dragStart);
            card.addEventListener('dragend', dragEnd);

            return card;
        }

        function buy(){
            const dropzonePlayerBoard = document.querySelector('.player-board .dropzone');
            const card = generateCard();
            
            dropzonePlayerBoard.appendChild(card); // Adicionar o card Ã  dropzone atual
            let zoneId = "player-board"

            console.log("IN THE FUNCTION BUY",card.id);
            let cardId = card.id

            console.log(dropzonePlayerBoard);
            socket.emit("buy",{cardId,zoneId,current_user})
        }

        
    </script>
</body>
</html>
